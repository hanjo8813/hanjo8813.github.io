---
title:  "[ë°ë¸Œì½”ìŠ¤] JDBC 3"
date: 2021-08-26
categories: 
  - TIL

# ê³ ì •ê°’
classes: wide
toc: false
toc_sticky: false
---

W4D4 - Embedded Database / NamedParameter JDBC Template / Transaction ì— ëŒ€í•´ ê³µë¶€í•´ë³´ì!


## Embedded Database

- ì™¸ë¶€ ìš”ì¸ì— ë”°ë¼ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆê°€ëŠ¥í•œ ìƒí™©ì´ ìˆì„ ìˆ˜ ìˆë‹¤ (MySQLì´ êº¼ì ¸ìˆê±°ë‚˜..)
- ë”°ë¼ì„œ Springì—ì„œëŠ” ì‹œìŠ¤í…œ ë‚´ë¶€ì—ì„œ ëŒì•„ê°€ëŠ” Embedded Databaseë¥¼ ì œê³µí•œë‹¤.
- í…ŒìŠ¤íŠ¸ DBì™€ ì‹¤ì œì‚¬ìš© DBë¥¼ ë¶„ë¦¬í•˜ì—¬ ì‚¬ìš©í•˜ëŠ”ê²ƒ

<br>

## H2

- **ìë°” ê¸°ë°˜** ì˜¤í”ˆì†ŒìŠ¤ RDBMS
- in-memory ë°ì´í„° ìŠ¤í† ë¦¬ì˜ ë©”ì¸ ë©”ëª¨ë¦¬ì— ì„¤ì¹˜ë˜ì–´ ìš´ì˜ëœë‹¤
- í…ŒìŠ¤íŠ¸ìš© DBì´ë¯€ë¡œ ë§¤ìš° ê°€ë³ë‹¤.
- ë‹¨ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ DBMSì˜ SQL ë¬¸ë²•ì„ **ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.**

### ì‚¬ìš©ë²•

- `pom.xml` dependencyì— h2 databaseë¥¼ ì¶”ê°€í•´ì¤€ë‹¤

```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>
```

- DataSource Beanì— ì—°ê²° ì •ë³´ ì •ì˜í•˜ê¸°

```java
@Bean
public DataSource dataSource() {
    // Datasourceë¥¼ ìƒì†ë°›ìœ¼ë¯€ë¡œ ë°”ë¡œ ë¦¬í„´
    return new EmbeddedDatabaseBuilder()
            .generateUniqueName(true)
            .setType(H2)
            .setScriptEncoding("UTF-8")
            .ignoreFailedDrops(true)
            .addScript("schema.sql")    // resources í•˜ìœ„ì— sql íŒŒì¼ì„ ì •ì˜í•´ì¤˜ì•¼í•¨
            .build();
}
```

<br>

## Embedded MySQL

- ë§Œì•½ ì—°ë™ DBê°€ MySQLì´ë¼ ì¿¼ë¦¬ë¬¸ì— MySQL ì „ìš© ë¬¸ë²•ì´ ì‚¬ìš©ë˜ì—ˆë‹¤ë©´?
    - -> H2ì™€ëŠ” ì¿¼ë¦¬ë¬¸ì´ ì—°ë™ë˜ì§€ ì•ŠìŒ -> Embedded MySQLì„ ì‚¬ìš©í•´ì•¼í•¨

### ì‚¬ìš©ë²•

- `pom.xml` dependencyì— Embedded MySQLì„ ì¶”ê°€í•´ì¤€ë‹¤

```xml
<dependency>
	<groupId>com.wix</groupId>
	<artifactId>wix-embedded-mysql</artifactId>
	<version>4.6.1</version>
	<scope>test</scope>
</dependency>
```

- ëª¨ë“ˆì‚¬ìš©ë²•ì€ [ì—¬ê¸°](https://github.com/wix/wix-embedded-mysql)ë¥¼ ì°¸ê³ 
- mysql config -> ì ‘ì†ì •ë³´ + í…ŒìŠ¤íŠ¸ìš© DBë¥¼ ë§Œë“¤ê³  ì‹œì‘í•œë‹¤
- ì´ ì ‘ì† ì •ë³´ë¥¼ ê°€ì§€ê³  DataSource Beanì— ì •ì˜í•´ì£¼ì

```java
var mysqlConfig = aMysqldConfig(ë²„ì „)  
        .withCharset(UTF8)
        .withPort(2215)                 
        .withUser(í˜¸ìŠ¤íŠ¸ëª…, ë¹„ë²ˆ)      
        .withTimeZone("Asia/Seoul")
        .build();

anEmbeddedMysql(mysqlConfig)
        .addSchema(DBëª…), classPathScript("schema.sql"))    // resources í•˜ìœ„ì— sql íŒŒì¼ì„ ì •ì˜í•´ì¤˜ì•¼í•¨
        .start();
```

### ì˜¤ë¥˜

![image](https://user-images.githubusercontent.com/71180414/130952855-48e21614-fd8b-4b2f-b06e-7502b421b8fc.png){:width="800"}

- ë§¤ìš° í™”ê°€ë‚œë‹¤ `v8_0_11`ë¡œ ì‹¤í–‰í•˜ë‹ˆ ì´ëŸ° ì˜¤ë¥˜ê°€ ëœ¨ë©´ì„œ ì‹¤í–‰ì´ ì•ˆë¨
- [ì—¬ê¸°](https://github.com/wix/wix-embedded-mysql/issues/157){:target="_blank"}ë¥¼ ì°¸ê³ í•˜ë‹ˆ... ìœˆë„ìš°ì—ì„œ C++ íŒ¨ì¹´ì§€ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì„ë•Œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë¼ê³  í•¨
    - ~~ë‚˜ëŠ” ê¹”ë ¤ìˆëŠ”ë°ë„ ì˜¤ë¥˜ê°€ ëœ¬ë‹¤. í•´ê²°ë¶ˆê°€..~~

<br>

## NamedParameter JDBC Template

- `NamedParameterJdbcTemplate` íƒ€ì…ìœ¼ë¡œ jdbc í…œí”Œë¦¿ì„ ìƒì„±í•œë‹¤.
- ê¸°ì¡´ jdbc í…œí”Œë¦¿ì˜ ë©”ì†Œë“œëŠ” ì¸ìê°’ì„ ì§ì ‘ ë§¤í•‘í•´ì„œ ë„£ì–´ì¤˜ì•¼ í–ˆì§€ë§Œ, NamedParameter í…œí”Œë¦¿ì€ Mapì˜ keyë¥¼ ì´ìš©í•´ ë„£ëŠ”ë‹¤.
- ë¯¸ë¦¬ `ParamMap`ì„ `<call key, mapping v>`ë¡œ ì •ì˜í•´ë‘ê³ , ì¿¼ë¦¬ì—ì„œëŠ” `:key`ë¡œ í˜¸ì¶œí•œë‹¤
    - ì¸ìê°’ì„ ìˆœì„œì— ë§ì¶° ë„£ì„ ë•Œì˜ ì‹¤ìˆ˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ì‚¬ìš©!

### ë©”ì†Œë“œ

```java
// ì¼ë°˜ JdbcTemplateê³¼ ë¦¬í„´ê°’ì€ ë™ì¼í•˜ì§€ë§Œ ì¸ìê°’ì´ ë‹¤ë¥´ë‹¤.
namedParameterJdbcTemplate.query(ì¿¼ë¦¬, RowMapper)
namedParameterJdbcTemplate.queryForObject(ì¿¼ë¦¬, ParamMap, RowMapper)
namedParameterJdbcTemplate.update(ì¿¼ë¦¬, ParamMap, Integer.class)
```

<br>

## Transaction

- íŠ¸ëœì­ì…˜ ê¸°ë³¸ ê°œë… - [ğŸš€ í¬ìŠ¤íŒ… ì´ë™](/til/11/)
- JDBCì—ì„œ ì˜¤í†  ì»¤ë°‹ default ê°’ì€ trueì´ë¯€ë¡œ... -> ì¿¼ë¦¬ê°€ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì—¬ì„œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- ë”°ë¼ì„œ `connection.setAutoCommit(false)`ë¡œ ì˜¤í†  ì»¤ë°‹ì„ êº¼ì£¼ê³  commitê³¼ rollbackì„ ì ìš©í•´ íŠ¸ëœì­ì…˜ì„ êµ¬í˜„í•œë‹¤.


### ê¸°ë³¸ flow ì˜ˆì œ

```java
...
    // ì˜¤í†  ì»¤ë°‹ì„ í’€ì–´ì„œ ì»¤ë°‹ ì „ê¹Œì§€ëŠ” í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì´ê²Œ ë§Œë“ ë‹¤
    connection.setAutoCommit(false);
    ...
    ì¿¼ë¦¬ ì‹¤í–‰
    ...
    connection.setAutoCommit(true);
} catch(ì—ëŸ¬) {
    // ì—ëŸ¬ ë°œìƒì‹œ ë¡¤ë°± ì‹œì¼œì¤Œ
    connection.rollback();
    connection.close();
}
```

<br>